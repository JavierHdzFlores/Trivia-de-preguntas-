<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trivia de Gemini</title>
    <!-- He usado Bootstrap para los estilos, como en tu archivo original -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Estilo para que el contenedor principal no sea demasiado ancho en pantallas grandes */
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 600px;
        }
        /* Estilo para los botones de opción al pasar el mouse */
        .btn-outline-primary:hover {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container mt-5 text-center">
        <h1 class="mb-4">Trivia de Preguntas</h1>

        <!-- Contenedor de contadores -->
        <div class="card p-3 mb-3 shadow-sm">
            <div class="d-flex justify-content-center align-items-center">
                <span class="fs-5 me-4 text-success">&check; Correctas: <strong id="correctas">0</strong></span>
                <span class="fs-5 text-danger">&#10008; Incorrectas: <strong id="incorrectas">0</strong></span>
            </div>
        </div>

        <!-- Contenedor de la pregunta y opciones -->
        <div id="question-container" class="card p-4 shadow-sm">
            <p id="question" class="fs-5">Cargando pregunta de Gemini...</p>
            <div id="options" class="d-grid gap-2 mt-3">
                <!-- Las opciones se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Botón de reinicio -->
        <button id="reset-btn" class="btn btn-warning mt-3">Reiniciar Marcador</button>
    </div>

    <!--
    ¡Aquí empieza toda la magia!
    He movido todo tu JavaScript aquí dentro de una etiqueta <script type="module">
    -->
    <script type="module">
        "use strict";

        // --- 1. CONFIGURACIÓN INICIAL ---

        // ¡¡IMPORTANTE!!
        // Pega aquí tu clave de API de Google Gemini.
        const API_KEY = "AIzaSyBb8uyOblHUjI1vIJWbZwBkEz0D13c0OWQ"; // <--- ¡PÉGALA AQUÍ!

        // Modelo de Gemini que usaremos
        const MODEL = "gemini-2.5-flash-preview-09-2025";

        // Lista de temas (como en tu README)
        const temas = [
            "concepto de arreglo y operaciones sobre arreglos",
            "concepto de diccionarios y funciones básicas",
            "operadores lógicos, aritméticos, de comparación, ternario",
            "uso de la consola para debuggear",
            "funciones con parámetros por default",
            "diferencias entre var, let y const",
            "eventos del DOM en JavaScript",
            "propiedades de Flexbox en CSS",
            "selectores básicos de CSS",
            "etiquetas semánticas de HTML5"
        ];

        // Referencias a los elementos del DOM
        const correctasEl = document.getElementById('correctas');
        const incorrectasEl = document.getElementById('incorrectas');
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const resetBtn = document.getElementById('reset-btn');

        // Variables para llevar el estado
        let correctas = 0;
        let incorrectas = 0;
        let datosPreguntaActual = null; // Para guardar la respuesta correcta
        let cargando = false; // Para evitar clics múltiples

        // --- 2. LÓGICA DE LOCALSTORAGE ---

        /**
         * Carga los contadores desde localStorage y los muestra en la página.
         */
        function desplegarContadores() {
            correctas = parseInt(localStorage.getItem('triviaCorrectas') || '0');
            incorrectas = parseInt(localStorage.getItem('triviaIncorrectas') || '0');
            correctasEl.textContent = correctas;
            incorrectasEl.textContent = incorrectas;
        }

        /**
         * Actualiza el contador (correctas o incorrectas) y lo guarda en localStorage.
         * @param {boolean} esCorrecta - True si la respuesta fue correcta.
         */
        function actualizarContador(esCorrecta) {
            if (esCorrecta) {
                correctas++;
            } else {
                incorrectas++;
            }
            // Guardar en localStorage
            localStorage.setItem('triviaCorrectas', correctas);
            localStorage.setItem('triviaIncorrectas', incorrectas);
            // Actualizar la vista
            correctasEl.textContent = correctas;
            incorrectasEl.textContent = incorrectas;
        }

        /**
         * Reinicia los marcadores a 0.
         */
        function reiniciarMarcador() {
            localStorage.clear(); // Limpia todo el localStorage para esta app
            correctas = 0;
            incorrectas = 0;
            correctasEl.textContent = correctas;
            incorrectasEl.textContent = incorrectas;
            // Carga una nueva pregunta para empezar de nuevo
            cargarPregunta();
        }

        // --- 3. LÓGICA DE LA API DE GEMINI (Tu función) ---

        /**
         * Llama a la API de Gemini para obtener una nueva pregunta.
         * (Esta es tu función de respuestaAPI() del README, con leves ajustes)
         */
        async function obtenerDatosPregunta() {
            if (cargando) return; // Evita llamadas duplicadas
            cargando = true;

            if (!API_KEY) {
                questionEl.textContent = 'Error: API_KEY no configurada. Por favor, edita el archivo HTML y añade tu clave.';
                questionEl.className = 'fs-5 text-danger';
                cargando = false;
                return null;
            }

            // Selecciona un tema aleatorio (como en tu README)
            const temaAleatorio = temas[Math.floor(Math.random() * temas.length)];

            // Prompt (como en tu README)
            const prompt = `En el contexto de JavaScript, CSS y HTML. Genera una pregunta de opción múltiple sobre el siguiente tema: ${temaAleatorio}. Proporciona cuatro opciones de respuesta y señala cuál es la correcta.
            Genera la pregunta y sus posibles respuestas en formato JSON como el siguiente ejemplo, asegurándote de que el resultado SÓLO contenga el objeto JSON y no texto adicional:
            {
              "question": "¿Cuál de los siguientes métodos agrega un elemento al final de un arreglo en JavaScript?",
              "options": [
                "a) shift()",
                "b) pop()",
                "c) push()",
                "d) unshift()",
              ],
              "correct_answer": "c) push()",
              "explanation": "El método push() agrega uno o más elementos al final de un arreglo."
            }`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(
                    url,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.5, // Un poco más de variedad
                                responseMimeType: "application/json"
                            },
                        }),
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error HTTP ${response.status}: ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();

                // Extracción del texto (como en tu README)
                const textResult = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (textResult) {
                    // Limpiamos la respuesta por si acaso trae algo antes o después del JSON
                    const textResultTrimmed = textResult.trim();
                    const firstBraceIndex = textResultTrimmed.indexOf('{');
                    const lastBraceIndex = textResultTrimmed.lastIndexOf('}');
                    const jsonString = textResultTrimmed.substring(firstBraceIndex, lastBraceIndex + 1);

                    const questionData = JSON.parse(jsonString);
                    cargando = false;
                    return questionData;
                } else {
                    throw new Error("No se pudo extraer el texto de la respuesta de la API.");
                }

            } catch (error) {
                console.error("Hubo un error en la petición:", error);
                questionEl.textContent = 'Error al cargar la pregunta. Revisa la consola para más detalles.';
                questionEl.className = 'fs-5 text-danger';
                cargando = false;
                return null;
            }
        }

        // --- 4. LÓGICA DEL JUEGO (Nuevas funciones) ---

        /**
         * Muestra la pregunta y las opciones en la página.
         * @param {object} datosPregunta - El objeto JSON de la API.
         */
        function desplegarPregunta(datosPregunta) {
            if (!datosPregunta) return;

            datosPreguntaActual = datosPregunta; // Guarda los datos para verificación

            // Muestra la pregunta
            questionEl.textContent = datosPregunta.question;
            questionEl.className = 'fs-5 text-dark'; // Clase normal

            // Limpia opciones anteriores
            optionsEl.innerHTML = '';

            // Crea y añade los botones de opciones
            datosPregunta.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary';
                button.textContent = option;
                
                // Añade el evento de clic para verificar la respuesta
                button.onclick = () => verificarRespuesta(option);
                
                optionsEl.appendChild(button);
            });
        }

        /**
         * Verifica la respuesta seleccionada por el usuario.
         * @param {string} opcionSeleccionada - El texto de la opción que el usuario eligió.
         */
        function verificarRespuesta(opcionSeleccionada) {
            if (cargando) return; // No hacer nada si ya se está cargando la siguiente

            const esCorrecta = opcionSeleccionada === datosPreguntaActual.correct_answer;
            actualizarContador(esCorrecta);

            // Deshabilitar todos los botones y mostrar colores
            const botones = Array.from(optionsEl.children);
            botones.forEach(btn => {
                btn.disabled = true;
                // Si esta es la respuesta correcta, márcala en verde
                if (btn.textContent === datosPreguntaActual.correct_answer) {
                    btn.className = 'btn btn-success';
                }
                // Si esta es la opción seleccionada y es incorrecta, márcala en rojo
                else if (btn.textContent === opcionSeleccionada) {
                    btn.className = 'btn btn-danger';
                }
            });

            // Cargar la siguiente pregunta después de un breve retraso
            setTimeout(cargarPregunta, 2000); // Espera 2 segundos
        }

        /**
         * Función principal para cargar una nueva pregunta.
         * (Tu función cargarPregunta() del README, modificada)
         */
        async function cargarPregunta() {
            // Mostrar mensaje de carga
            questionEl.className = 'fs-5 text-muted'; // Un gris mientras carga
            questionEl.textContent = 'Cargando pregunta de Gemini...';
            optionsEl.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>'; // Spinner de Bootstrap

            const datosPregunta = await obtenerDatosPregunta();

            if (datosPregunta) {
                desplegarPregunta(datosPregunta);
            }
        }

        // --- 5. INICIO DE LA APLICACIÓN ---

        /**
         * Se ejecuta cuando la página se carga por primera vez.
         */
        window.onload = () => {
            console.log("Página cargada. Iniciando app de trivia.");
            desplegarContadores(); // Carga el marcador de localStorage
            cargarPregunta();     // Carga la primera pregunta
            
            // Asigna el evento al botón de reinicio
            resetBtn.onclick = reiniciarMarcador;
        };

    </script>

    <!-- Scripts de Bootstrap (como en tu archivo original) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>